---
title: "Module 1: Tabular Data"
subtitle: "Working with larger-than-RAM data using duckdbfs"
author: "ESPM 288"
format:
  html:
    embed-resources: true
    df-print: kable
---

## Introduction

In this module, we will explore high-performance workflows for tabular data. We will use `duckdbfs` to work with datasets that are larger than available RAM by leveraging DuckDB's streaming and remote file access capabilities.

## Case Study: Global Supply Chains

We will be working with [EXIOBASE 3.8.1](https://source.coop/youssef-harby/exiobase-3), a global Multi-Regional Input-Output (MRIO) database. This dataset tracks economic transactions between sectors and regions, along with their environmental impacts (emissions, resource use, etc.).

**Data description:**
- **Coverage**: 44 countries + 5 rest-of-world regions.
- **Timeframe**: 1995â€“2022.
- **Content**: Economic transactions (Z matrix), final demand (Y matrix), and environmental stressors (F matrix).
- **Format**: Cloud-optimized Parquet, partitioned by year and matrix type.

## Setup

```{r}
library(duckdbfs)
library(dplyr)
library(ggplot2)

```

## Exercise 1: connecting to remote data

We can open the entire dataset without downloading it using `open_dataset()`. The data is hosted on Source Cooperative. The `**` pattern allows recursive scanning of the partitioned parquet files.

```{r}
# Remote S3 path to EXIOBASE 3 (Source Cooperative)

duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)

# View the schema (column names and types) without reading data
glimpse(exio)

# For CO2 data specifically, we want the F_satellite matrix
co2_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/year=*/format=ixi/matrix=F_satellite/"

co2_data <- open_dataset(co2_url)

# View the CO2 data structure
glimpse(co2_data)

# Preview a few rows - filter for CO2 stressors
co2_data |>
    filter(stressor %like% "%CO2%") |>
    head(10) |>
    collect()
```

## Exercise 2: Efficient Filtering

The dataset is large. We should filter *before* collecting any data into R.

```{r}
exio |>
    filter(year == 2022, region == "US") |>
    head() |>
    collect()
```

> **Task**: Construct a query to find the top 5 sectors in the US by CO2 emissions in 2022. Remember to check the column names in `exio` to find the appropriate emissions flow.
```{r}
# Query to find top 5 sectors in the US by CO2 emissions in 2022
top5_us_sectors <- co2_data |>
    filter(year == 2022, region == "US", stressor %like% "%CO2%") |>
    group_by(sector) |>
    summarize(
        total_co2 = sum(value, na.rm = TRUE),
        unit = first(unit)
    ) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

# Display results
top5_us_sectors |>
    knitr::kable(
        caption = "Top 5 US Sectors by CO2 Emissions (2022)",
        col.names = c("Sector", "Total CO2", "Unit"),
        format.args = list(big.mark = ",")
    )

# Visualize the top 5 sectors
y_unit <- if (nrow(top5_us_sectors) > 0 && !is.na(top5_us_sectors$unit[1])) {
    top5_us_sectors$unit[1]
} else {
    "unknown unit"
}
ggplot(top5_us_sectors, aes(x = reorder(sector, total_co2), y = total_co2, fill = sector)) +
    geom_col() +
    coord_flip() +
    labs(
        title = "Top 5 CO2 Emitting Sectors in the US (2022)",
        x = "Sector",
        y = paste0("Total CO2 Emissions (", y_unit, ")"),
        fill = "Sector"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
```
## Exercise 3: Top 5 CO2 Emitters in 2022

Find the top 5 countries by total CO2 emissions in 2022.

```{r}
# Query to find top 5 CO2 emitters in 2022
top5_emitters_2022 <- co2_data |>
    filter(year == 2022, stressor %like% "%CO2%") |>
    group_by(region) |>
    summarize(
        total_co2 = sum(value, na.rm = TRUE),
        unit = first(unit)
    ) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

# Display results
top5_emitters_2022 |>
    knitr::kable(
        caption = "Top 5 CO2 Emitting Countries (2022)",
        col.names = c("Country", "Total CO2", "Unit"),
        format.args = list(big.mark = ",")
    )

# Visualize the top 5 emitters
ggplot(top5_emitters_2022, aes(x = reorder(region, total_co2), y = total_co2, fill = region)) +
    geom_col() +
    coord_flip() +
    labs(
        title = "Top 5 CO2 Emitters in 2022",
        x = "Country",
        y = paste0("Total CO2 Emissions (", top5_emitters_2022$unit[1], ")"),
        fill = "Country"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
```


